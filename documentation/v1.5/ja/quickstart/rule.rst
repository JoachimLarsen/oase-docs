====================
ルール作成と本番適用
====================

| ルールの作成方法について、説明します。


.. _new_rule:

ルール作成
==========

.. |download_icon| image:: ../images/quickstart/download_icon.png

| ルールの作成には、ディシジョンテーブルファイルを利用します。
| ディシジョンテーブルファイルのダウンロードは、画面上部のメニューの :menuselection:`ルール --> ディシジョンテーブル` から行います。
| :doc:`decision_table` で作成した :program:`新規ディシジョンテーブル` のダウンロードアイコン |download_icon| をクリックし、ディシジョンテーブルファイルをダウンロードします。


.. figure:: ../images/quickstart/new_rule_01.png
   :width: 400px
   :align: center

   ディシジョンテーブルダウンロード

| ディシジョンテーブルファイルを開き、ルールを追加します。
| 記載内容の詳細についてはここでは説明を省略します。詳細は、:doc:`../decision_table/rule` を参照して下さい。

| 特に重要な項目としては、下記となります。

* アラートメッセージ(正規表現可 一致)

  * 監視アプリケーションから取得したアラートメッセージのマッチ条件を定義します。今回は、取得したアラート全てに対して、ITA を実行する条件となります。

* アクションパラメータ情報（必須）

  * 自動化ソフトウェアのアクションドライバとそのパラメータを指定します。

  * :program:`ITA_NAME`
  
    * :doc:`action_driver` で作成したアクションドライバのアクションドライバ名を指定します。

  * :program:`CONDUCTOR_CLASS_ID`

    * Exastro OASE から実行する ITA の ConductorクラスIDを指定します。

  * :program:`OPERATION_ID`

    * Exastro OASE から実行する ITA の Conductor に紐付けるオペレーション ID を指定します。



| また、本項で扱う全ての項目は下記となります。

+-------------------------------------+---------------------------------------------------------------------------+
| ルール説明                          | クイックスタート                                                          |
+-------------------------------------+---------------------------------------------------------------------------+
| アラートメッセージ(正規表現可 一致) | .*                                                                        |
+-------------------------------------+---------------------------------------------------------------------------+
| ルール名 （必須）                   | 新規ルール                                                                |
+-------------------------------------+---------------------------------------------------------------------------+
| 発生事象（必須）                    | アラートを検知                                                            |
+-------------------------------------+---------------------------------------------------------------------------+
| 対処概要（必須）                    | ITAを実行                                                                 |
+-------------------------------------+---------------------------------------------------------------------------+
| アクション種別                      | ITA(ver1)                                                                 |
+-------------------------------------+---------------------------------------------------------------------------+
| アクションパラメータ情報（必須）    | ITA_NAME=新規ZABBIXアクションドライバ,CONDUCTOR_CLASS_ID=1,OPERATION_ID=1 |
+-------------------------------------+---------------------------------------------------------------------------+
| 承認メールパラメータ情報（必須）    | X                                                                         |
+-------------------------------------+---------------------------------------------------------------------------+
| リトライ間隔（必須）                | 1                                                                         |
+-------------------------------------+---------------------------------------------------------------------------+
| リトライ回数（必須）                | 1                                                                         |
+-------------------------------------+---------------------------------------------------------------------------+
| 抑止間隔（必須）                    | 0                                                                         |
+-------------------------------------+---------------------------------------------------------------------------+
| 条件回数（必須）                    | X                                                                         |
+-------------------------------------+---------------------------------------------------------------------------+
| 条件期間(秒)（必須）                | X                                                                         |
+-------------------------------------+---------------------------------------------------------------------------+
| 大グループ（必須）                  | X                                                                         |
+-------------------------------------+---------------------------------------------------------------------------+
| 優先順位（必須）                    | X                                                                         |
+-------------------------------------+---------------------------------------------------------------------------+
| 小グループ（必須）                  | X                                                                         |
+-------------------------------------+---------------------------------------------------------------------------+
| 優先順位（必須）                    | X                                                                         |
+-------------------------------------+---------------------------------------------------------------------------+
| 有効日                              |                                                                           |
+-------------------------------------+---------------------------------------------------------------------------+
| 無効日                              |                                                                           |
+-------------------------------------+---------------------------------------------------------------------------+

.. figure:: ../images/quickstart/new_rule_02.png
   :width: 800px
   :align: center

   ディシジョンテーブルファイル(一部)

| ルールの記述が完了したら、ファイルを保存します。

新規トークンの払い出し
======================

| API 連携に必要なトークンの払い出しを行います。
| 新規トークンの払い出しは、画面上部のメニューの :menuselection:`ルール --> トークン払い出し` から行えます。
| トークンの詳細は、:doc:`../api/token` を参照してください。

.. tip:: トークンは、ルールの検証を行う際のテストリクエスト送信でも必要となります。

| 画面上部にある、:guilabel:`新規トークン払い出し` をクリックします。

.. figure:: ../images/quickstart/new_token_01.png
   :scale: 30%
   :align: left

   トークン払い出し

.. glossary::

   トークン名 : た
      | トークン名を入力します。
      |  :program:`新規トークン` として登録します。

   有効期限 : や
      | トークンの有効期限を指定します。
      | 未記入(有効期限なし)として登録します

   権限の設定 : か
      | グループに割り当てる権限を定義します。
      |  :program:`権限あり` に設定します。

.. raw:: html

   <div style="clear:both;"></div>

| 項目の入力が完了したら、:guilabel:`トークン払い出し` をクリックします。
| トークンが画面上に表示されますが、後から確認できるので記録は不要です。


ルールの検証
============

| ルールの設定は、画面上部のメニューの :menuselection:`ルール --> ルール` から行えます。
| 画面上部にある :guilabel:`ファイルを選択` をクリックし、 :ref:`new_rule` で作成したディシジョンテーブルファイルを選択します。
| 選択したファイルが正しいことを確認し、:guilabel:`アップロード` をクリックします。

.. figure:: ../images/quickstart/rule_apply_01.png
   :width: 800px
   :align: center

| :menuselection:`作業ステータス` が :program:`ステージング適用完了` になっていることを確認します。
| :guilabel:`テストリクエスト` をクリックします。

.. tip:: 何らかの問題がある場合は、 ダウンロードボタン |download_icon| をクリックし、ログファイルを確認して下さい。


.. figure:: ../images/quickstart/test_request_01.png
   :scale: 30%
   :align: left

   テストリクエスト(ディシジョンテーブル選択)

.. glossary::

   ディシジョンテーブル名選択 : た
      | テストを行う対象のディシジョンテーブルを選択します。
      |  :program:`新規ディシジョンテーブル` を選択します。

.. raw:: html

   <div style="clear:both;"></div>

| :guilabel:`テストリクエスト設定へ` をクリックします。

.. figure:: ../images/quickstart/test_request_02.png
   :scale: 30%
   :align: left

   テストリクエスト(テストリクエスト設定)

.. glossary::

   アラートメッセージ : あ
      | テストリクエストで送信するメッセージを設定します。
      |  :menuselection:`単発テスト` でアラートメッセージを :program:`This is test alert.` と入力します。

.. raw:: html

   <div style="clear:both;"></div>

| :guilabel:`実行` をクリックします。

.. figure:: ../images/quickstart/test_request_03.png
   :scale: 30%
   :align: left

   テストリクエスト(テストリクエスト設定)

| テストリクエストで送信したメッセージがディシジョンテーブルファイルのルールにマッチしていることを確認します。

.. raw:: html

   <div style="clear:both;"></div>

| :guilabel:`閉じる` をクリックします。
| 運用ステータスを :program:`検証完了` にするかどうかの確認があるので、:guilabel:`OK` をクリックします。


ルールの本番適用
================

.. |apply_icon| image:: ../images/quickstart/apply_icon.png

| ルールの本番適用は、画面上部のメニューの :menuselection:`ルール --> ルール` から行えます。
| 画面上部の **ステージング適用ルール** にある **適用ボタン** |apply_icon| をクリックします。

| 数秒～1分程度後に、 **作業ステータス** が **プロダクション適用完了** になります。

.. figure:: ../images/quickstart/rule_apply_02.png
   :width: 800px
   :align: center

| Exastro OASE が監視アプリケーションからアラートメッセージを取得すると、ITA の Conductor 実行します。